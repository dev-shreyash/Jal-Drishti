generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}



model Village {
  village_id     Int      @id @default(autoincrement())
  village_name   String
  taluka         String
  district       String
  state          String
  pincode        String
  population     Int?
  created_at     DateTime @default(now())

  admins         Admin[]
  operators      Operator[]
  residents      Resident[]
  pumps          Pump[]
  tanks          Tank[]
  announcements  Announcement[]
  ai_models      AiModel[]
}

model Admin {
  admin_id       Int      @id @default(autoincrement())
  name           String
  username       String   @unique
  password_hash  String
  email          String?
  contact_number String?
  village_id     Int
  created_at     DateTime @default(now())

  village        Village @relation(fields: [village_id], references: [village_id])
}

model Operator {
  operator_id    Int      @id @default(autoincrement())
  name           String
  phone          String
  username       String   @unique
  password_hash  String
  is_active      Boolean  @default(true)
  village_id     Int
  created_at     DateTime @default(now())

  village        Village @relation(fields: [village_id], references: [village_id])
  logs           DailyLog[]
  change_requests ChangeRequest[]
}

model Pump {
  pump_id           Int      @id @default(autoincrement())
  pump_name         String
  model_number      String?
  installation_date DateTime?
  last_maintained   DateTime?
  qr_code           String   @unique
  latitude          Float
  longitude         Float
  flow_rate_lph     Int
  is_smart_pump     Boolean  @default(false)
  village_id        Int

  village           Village @relation(fields: [village_id], references: [village_id])
  logs              DailyLog[]
  sensor_readings   SensorLog[]
  predictions       Prediction[]
  complaints        Complaint[]
  change_requests   ChangeRequest[]
}

model Tank {
  tank_id           Int      @id @default(autoincrement())
  tank_name         String
  capacity_liters   Int
  material_type     String?
  last_cleaned_date DateTime?
  latitude          Float?
  longitude         Float?
  is_smart_tank     Boolean  @default(false)
  village_id        Int

  village           Village @relation(fields: [village_id], references: [village_id])
  sensor_readings   SensorLog[]
}

model DailyLog {
  log_id         Int      @id @default(autoincrement())
  start_time     DateTime
  end_time       DateTime
  usage_liters   Float
  gps_lat        Float
  gps_lng        Float
  photo_url      String?
  chlorine_added Boolean  @default(false)
  chlorine_ppm   Float?
  created_at     DateTime @default(now())
  operator_id    Int
  pump_id        Int

  operator       Operator @relation(fields: [operator_id], references: [operator_id])
  pump           Pump     @relation(fields: [pump_id], references: [pump_id])

  @@index([start_time])
  @@index([pump_id, start_time])
}

model SensorLog {
  sensor_id    Int      @id @default(autoincrement())
  timestamp    DateTime @default(now())
  reading_type String
  value        Float
  unit         String
  pump_id      Int?
  tank_id      Int?

  pump         Pump? @relation(fields: [pump_id], references: [pump_id])
  tank         Tank? @relation(fields: [tank_id], references: [tank_id])
}

model Prediction {
  prediction_id    Int      @id @default(autoincrement())
  prediction_date  DateTime
  predicted_usage  Float
  shortage_flag    Boolean
  confidence_score Float?
  created_at       DateTime @default(now())
  pump_id          Int

  pump             Pump @relation(fields: [pump_id], references: [pump_id])
}

model Resident {
  resident_id  Int      @id @default(autoincrement())
  name         String
  phone        String   @unique
  password_hash String
  address      String?
  village_id   Int
  created_at   DateTime @default(now())

  village      Village @relation(fields: [village_id], references: [village_id])
  complaints   Complaint[]
}

model Complaint {
  complaint_id Int      @id @default(autoincrement())
  category     String
  description  String
  photo_url    String?
  status       String   @default("OPEN")
  created_at   DateTime @default(now())
  resolved_at  DateTime?
  resident_id  Int
  pump_id      Int?

  resident     Resident @relation(fields: [resident_id], references: [resident_id])
  pump         Pump?    @relation(fields: [pump_id], references: [pump_id])
}

model Announcement {
  id         Int      @id @default(autoincrement())
  title      String
  message    String
  date_posted DateTime @default(now())
  village_id Int

  village    Village @relation(fields: [village_id], references: [village_id])
}

model AiModel {
  model_id      Int      @id @default(autoincrement())
  trained_at    DateTime @default(now())
  algorithm     String   @default("ARIMA")
  model_weights Json
  village_id    Int

  village       Village @relation(fields: [village_id], references: [village_id])
}

model ChangeRequest {
  request_id       Int      @id @default(autoincrement())
  request_type     String
  status           String   @default("PENDING")
  operator_id      Int
  pump_id          Int?
  req_pump_name    String?
  req_model_number String?
  req_latitude     Float?
  req_longitude    Float?
  req_flow_rate    Int?
  req_is_smart     Boolean?
  reason           String?
  admin_remark     String?
  created_at       DateTime @default(now())
  resolved_at      DateTime?

  operator         Operator @relation(fields: [operator_id], references: [operator_id])
  pump             Pump?    @relation(fields: [pump_id], references: [pump_id])
}
